<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBQuery: Generative AI Assistant to your Database</title>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const userSection = document.getElementById("user-section");
            const adminSection = document.getElementById("admin-section");
            const roleRadios = document.querySelectorAll('input[name="role"]');

            roleRadios.forEach(radio => {
                radio.addEventListener("change", function () {
                    if (this.value === "user") {
                        userSection.style.display = "block"; // Show user section
                        // adminSection.style.display = "none"; // Hide admin section
                    } else if (this.value === "admin") {
                        // adminSection.style.display = "block"; // Show admin section
                        userSection.style.display = "none"; // Hide user section
                    }
                });
            });
        });

        async function fetchTables(selectedSection) {
            const tableDropdown = document.getElementById("table-dropdown");
            tableDropdown.innerHTML = '<option value="">Select Table</option>'; // Clear existing options
            if (selectedSection) {
                try {
                    const response = await fetch(`/get-tables/?selected_section=${selectedSection}`);
                    const data = await response.json();
                    if (data.tables && data.tables.length > 0) {
                        data.tables.forEach(table => {
                            const option = document.createElement("option");
                            option.value = table;
                            option.textContent = table;
                            tableDropdown.appendChild(option);
                        });
                    } else {
                        alert("No tables found for the selected section.");
                    }
                } catch (error) {
                    console.error("Error fetching tables:", error);
                    alert("An error occurred while fetching tables.");
                }
            }
        }

        async function fetchQuestions(selectedSection) {
            const questionDropdown = document.getElementById("questions-dropdown");
            questionDropdown.innerHTML = '<option value="">Select a Question</option>'; // Clear existing options
            if (selectedSection) {
                try {
                    const response = await fetch(`/get_questions/?subject=${selectedSection}`);
                    const data = await response.json();
                    if (data.questions && data.questions.length > 0) {
                        data.questions.forEach(question => {
                            const option = document.createElement("option");
                            option.value = question;
                            option.textContent = question;
                            questionDropdown.appendChild(option);
                        });
                    } else {
                        alert("No questions found for the selected section.");
                    }
                } catch (error) {
                    console.error("Error fetching questions:", error);
                    alert("An error occurred while fetching questions.");
                }
            }
        }

        function onSectionChange() {
            const selectedSection = document.getElementById("section-dropdown").value;
            if (selectedSection) {
                fetchTables(selectedSection);
                fetchQuestions(selectedSection);
            }
        }

        function chooseExampleQuestion() {
            const questionDropdown = document.getElementById("questions-dropdown");
            const selectedQuestion = questionDropdown.options[questionDropdown.selectedIndex].text;
            if (!selectedQuestion || selectedQuestion === "Select a Question") {
                alert("Please select a question.");
                return;
            }
            const userQueryInput = document.getElementById("user_query");
            userQueryInput.value = selectedQuestion; // Set selected question as user query
        }

        function handleSubmit(event) {
            event.preventDefault(); // Prevent default form submission

            const userQueryInput = document.getElementById("user_query");
            const promptInput = document.getElementById("prompt");

            // Set prompt based on user input or selected question
            if (userQueryInput.value.trim() !== "") {
                promptInput.value = userQueryInput.value.trim(); // Use entered query as prompt
            } else {
                const questionDropdown = document.getElementById("questions-dropdown");
                const selectedQuestion = questionDropdown.options[questionDropdown.selectedIndex].text;
                promptInput.value = selectedQuestion; // Use selected question as prompt
            }

            // Submit the form programmatically after setting the prompt
            event.target.submit();
        }
        let currentTable = null;
        let currentPage = 1;
        const recordsPerPage = 10;

        async function displayTableData(tableName, pageNumber = 1) {
            try {
                const response = await fetch(`/get_table_data/?table_name=${tableName}&page_number=${pageNumber}&records_per_page=${recordsPerPage}`);
                const data = await response.json();

                const tableDataDiv = document.getElementById("table-data");
                tableDataDiv.innerHTML = data.table_html;

                currentPage = data.page_number;
                currentTable = tableName;

                document.getElementById("prev-page-btn").disabled = currentPage === 1;
                document.getElementById("next-page-btn").disabled = currentPage * recordsPerPage >= data.total_records;
            } catch (error) {
                console.error("Error fetching table data:", error);
                alert("Failed to load table data.");
            }
        }

        function changePage(direction) {
            if (currentTable) {
                displayTableData(currentTable, currentPage + direction);
            }
        }

        function showRelevantTables(tables) {
            const tableDisplaySection = document.getElementById("table-display-section");
            const chosenTablesDiv = document.getElementById("chosen-tables");

            chosenTablesDiv.innerHTML = tables.map(table => `<button onclick="displayTableData('${table}')">${table}</button>`).join(", ");
            tableDisplaySection.style.display = "block";
        }
    </script>
</head>

<body>
    <h1>DBQuery: Generative AI Assistant to your Database</h1>
    <form action="/submit" method="post" onsubmit="handleSubmit(event)">
        <!-- Role Selection -->
        <h2>Select Role:</h2>
        <label><input type="radio" name="role" value="admin" required> Admin</label><br>
        <label><input type="radio" name="role" value="user" required> User</label><br>

        <!-- Admin Section (hidden by default) -->
        <!-- <div id="admin-section" style="display: none; margin-top: 20px;">
            <h2>Select Database:</h2>
            <select name="database" id="database-dropdown" required>
                <option value="" disabled selected>Select Database</option>
                {% for db in databases %}
                    <option value="{{ db }}">{{ db }}</option>
                {% endfor %}
            </select>
            
            <h2>Select Model:</h2>
            <select name="model" id="model-dropdown" required>
                <option value="" disabled selected>Select Model</option>
                {% for model in models %}
                    <option value="{{ model }}">{{ model }}</option>
                {% endfor %}
            </select>
        </div> -->

        <!-- User Section (hidden by default) -->
        <div id="user-section" style="display: none; margin-top: 20px;">
            <h2>Select Section:</h2>
            <select name="section" id="section-dropdown" onchange="onSectionChange()" required>
                <option value="" disabled selected>Select Section</option>
                {% for sec in section %}
                <option value="{{ sec }}">{{ sec }}</option>
                {% endfor %}
            </select>

            <h2>Select Table:</h2>
            <select name="table" id="table-dropdown" required>
                <option value="" disabled selected>Select Table</option> <!-- Dynamically populated -->
            </select>

            <h2>Select Example Question:</h2>
            <div style="display: flex; align-items: center;">
                <select name="example_question" id="questions-dropdown" required>
                    <option value="" disabled selected>Select a Question</option> <!-- Dynamically populated -->
                </select>
                <button type="button" onclick="chooseExampleQuestion()" style="margin-left: 10px;">Choose</button>
            </div>

            <p id="selected-question-display" style="margin-top: 10px; color: blue;"></p>

            <h2>Your Query:</h2>
            <input type="text" id="user_query" name="user_query" placeholder="Enter your query here..." required>

            <!-- Hidden field for the prompt -->
            <input type="hidden" id="prompt" name="prompt">

            <button type="submit" style="margin-top: 20px;">Submit</button>
        </div>
    </form>

</body>

</html>